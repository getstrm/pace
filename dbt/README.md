# dbt module

This PACE module is used to extend dbt with Data Policies as PACE knows them.

## Setup

Assuming that you have a Python environment set up (feel free to use Pipenv, Virtualenv, etc), you
can install the required packages with the following command:

```shell
pip install dbt-postgres
pip install dbt-bigquery
```

The directory `dbt_sample_project` has been created with the following command:

```shell
dbt init dbt_sample_project
dbt seed
```

## To do

- BigQuery: retrieve user groups table from a DBT configuration or runtime param/environment var.
- Make pace-dbt executable as a jar.
  - ✅ Write PACE view SQL to corresponding models dir, taking target ref into account.
- Find out a way to integrate PACE into the dbt workflow without making it a manual step.
- Return detailed validation feedback to the user.
- ✅ Add support for specifying field transforms in column meta.
    - For docs: target ref fqn doesn't necessarily need to be specified, there is a default suffix
      of '_view'. However, the target dataset is then the same, which may not be desired from an
      access
      perspective. See caveats.
- ✅ IntegrationFqn and resource path are not equal to fqn (esp. schema) on the underlying platform.
- ✅ BigQuery PACE views should be authorized views. Jinja config,
  see https://docs.getdbt.com/reference/resource-configs/bigquery-configs#authorized-views.
- ✅ Take custom schema (or dataset) names into account (jinja config in model files).
- ✅ Add autogenerated header for generated sql files to instruct the user to the correct workflow.
- ✅ Fully support multiple rule sets for a single model (when using model meta only).

PACE Core:
- Ensure it's possible to extend an existing ruleset with a global transform
- Global rule sets may result in duplicate target refs
- Fix integration test
- ✅ If a data type is absent in a source schema, fall back to implicit types, that require explicit
  quotes in the rule set YAML in the schema.yml model. -> we require literals for dbt models, as
  data types are often absent.

## Caveats

- With BigQuery, the user groups table should be in the same region as the table for which a view is
  created.
- A custom `generate_schema_name` macro is needed to allow specifying a different schema for the
  PACE views.
  See https://discourse.getdbt.com/t/from-where-does-dbt-bigquery-take-project-and-dataset-while-running-the-model/9046/2
